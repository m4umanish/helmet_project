<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è Helmet Detection System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 25px;
            min-height: calc(100vh - 40px);
        }

        .main-content {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .sidebar {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: fit-content;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 800;
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48cae4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(255, 107, 107, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            color: #b8c6db;
        }

        .video-container {
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            position: relative;
            border: 2px solid rgba(72, 202, 228, 0.3);
        }

        .video-feed {
            width: 100%;
            height: auto;
            max-height: 550px;
            object-fit: cover;
            display: block;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
            padding: 20px;
            z-index: 10;
        }

        .camera-info {
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        .system-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-left: 15px;
            text-transform: uppercase;
        }

        .status-running {
            background: linear-gradient(45deg, #28a745, #20c997);
            animation: pulse-green 2s infinite;
        }

        .status-stopped {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
        }

        @keyframes pulse-green {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-start {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-start:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .btn-stop {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-stop:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
        }

        .btn-reset {
            background: linear-gradient(45deg, #6f42c1, #e83e8c);
            color: white;
            box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3);
        }

        .btn-reset:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(111, 66, 193, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-color: rgba(72, 202, 228, 0.5);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #48cae4, #feca57);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.95rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .sidebar h3 {
            margin-bottom: 20px;
            color: #feca57;
            text-align: center;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .camera-list {
            margin-bottom: 30px;
        }

        .camera-item {
            background: rgba(255, 255, 255, 0.08);
            padding: 18px;
            border-radius: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .camera-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(8px);
            border-color: rgba(72, 202, 228, 0.3);
        }

        .camera-item.active {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.2);
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
        }

        .camera-name {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .camera-id {
            font-size: 0.85rem;
            opacity: 0.7;
            font-weight: 500;
        }

        .status-indicator {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .status-indicator.status-running {
            background: #28a745;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.6);
            animation: pulse-indicator 2s infinite;
        }

        .status-indicator.status-stopped {
            background: #dc3545;
            opacity: 0.6;
        }

        @keyframes pulse-indicator {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        .alert {
            padding: 18px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-weight: 600;
            border: 1px solid;
            backdrop-filter: blur(10px);
        }

        .alert-success {
            background: rgba(40, 167, 69, 0.2);
            border-color: rgba(40, 167, 69, 0.4);
            color: #d4edda;
        }

        .alert-danger {
            background: rgba(220, 53, 69, 0.2);
            border-color: rgba(220, 53, 69, 0.4);
            color: #f8d7da;
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.2);
            border-color: rgba(255, 193, 7, 0.4);
            color: #fff3cd;
        }

        .violation-alert {
            background: linear-gradient(45deg, rgba(220, 53, 69, 0.9), rgba(253, 126, 20, 0.9));
            color: white;
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.4rem;
            font-weight: 800;
            display: none;
            animation: violation-pulse 2s infinite;
            box-shadow: 0 0 30px rgba(220, 53, 69, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        @keyframes violation-pulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 0 0 30px rgba(220, 53, 69, 0.5);
            }
            50% { 
                opacity: 0.8; 
                transform: scale(1.02);
                box-shadow: 0 0 40px rgba(220, 53, 69, 0.7);
            }
        }

        .violation-info {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .violation-info h4 {
            color: #feca57;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .violation-path {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            background: rgba(0, 0, 0, 0.4);
            padding: 12px;
            border-radius: 8px;
            word-break: break-all;
            margin: 8px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #48cae4;
        }

        .violation-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .violation-stat {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .violation-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ff6b6b;
        }

        .violation-stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
            text-transform: uppercase;
        }

        .log-panel {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .timestamp {
            color: #48cae4;
            font-weight: 600;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn:disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(72, 202, 228, 0.5);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(72, 202, 228, 0.7);
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 10px;
            }
            
            .controls {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header h1 {
                font-size: 2.2rem;
            }
            
            .main-content, .sidebar {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>Helmet Detection System</h1>
                <p>Real-time AI-powered safety monitoring and violation detection</p>
            </div>

            <div id="alertContainer"></div>

            <div class="violation-alert" id="violationAlert">
                HELMET VIOLATION DETECTED!
            </div>

            <div class="video-container">
                <img src="/video_feed" alt="Video Feed" class="video-feed" id="videoFeed">
                <div class="video-overlay">
                    <div class="camera-info" id="cameraInfo">
                        System Status: Stopped
                        <span class="system-status status-stopped" id="systemStatusBadge">Stopped</span>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-start" onclick="startDetection()" id="startBtn">
                    <span id="startText">Start Detection</span>
                </button>
                <button class="btn btn-stop" onclick="stopDetection()" id="stopBtn">
                    <span id="stopText">Stop Detection</span>
                </button>
                <button class="btn btn-reset" onclick="resetViolations()" id="resetBtn">
                    Reset Violations
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalViolations">0</div>
                    <div class="stat-label">Total Violations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeViolations">0</div>
                    <div class="stat-label">Active Violations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="currentFPS">0</div>
                    <div class="stat-label">Current FPS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="systemStatus">Stopped</div>
                    <div class="stat-label">System Status</div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <h3>Camera Control</h3>
            
            <div class="camera-list" id="cameraList">
                <div class="camera-item">
                    <div class="camera-name">Loading cameras...</div>
                </div>
            </div>

            <h3>Violation Information</h3>
            <div class="violation-info" id="violationInfo">
                <h4>Save Directory:</h4>
                <div class="violation-path" id="saveDirectory">Loading...</div>
                <div class="violation-stats">
                    <div class="violation-stat">
                        <div class="violation-stat-value" id="totalFiles">0</div>
                        <div class="violation-stat-label">Total Files</div>
                    </div>
                    <div class="violation-stat">
                        <div class="violation-stat-value" id="diskUsage">0 MB</div>
                        <div class="violation-stat-label">Disk Usage</div>
                    </div>
                </div>
                <p style="margin-top: 15px; opacity: 0.8;"><strong>Last Violation:</strong></p>
                <div class="violation-path" id="lastViolation" style="font-size: 0.8rem;">None</div>
            </div>

            <h3>Activity Log</h3>
            <div class="log-panel" id="logPanel">
                <div class="log-entry">
                    <div class="timestamp">System initialized and ready</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state management
        let isDetectionRunning = false;
        let cameras = [];
        let selectedCamera = 'camera_1';
        let statsInterval;
        let lastViolationCount = 0;

        // Initialize the system when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
            startStatsUpdater();
        });

        // System initialization
        function initializeSystem() {
            loadCameras();
            loadViolationInfo();
            updateStats();
            logActivity('System ready for operation');
            
            // Set up error handling for video feed
            const videoFeed = document.getElementById('videoFeed');
            videoFeed.onerror = function() {
                logActivity('Video feed connection lost');
            };
        }

        // Load available cameras
        async function loadCameras() {
            try {
                const response = await fetch('/get_cameras');
                if (!response.ok) throw new Error('Failed to fetch cameras');
                
                cameras = await response.json();
                
                const cameraList = document.getElementById('cameraList');
                cameraList.innerHTML = '';
                
                if (cameras.length === 0) {
                    cameraList.innerHTML = '<div class="camera-item"><div class="camera-name">No cameras configured</div></div>';
                    return;
                }
                
                cameras.forEach(camera => {
                    const cameraItem = document.createElement('div');
                    cameraItem.className = `camera-item ${camera.active ? 'active' : ''}`;
                    cameraItem.onclick = () => selectCamera(camera.id);
                    
                    cameraItem.innerHTML = `
                        <div class="camera-name">
                            ${camera.name} 
                            <span class="status-indicator status-stopped" id="status-${camera.id}"></span>
                        </div>
                        <div class="camera-id">ID: ${camera.id}</div>
                    `;
                    
                    cameraList.appendChild(cameraItem);
                    
                    if (camera.active) {
                        selectedCamera = camera.id;
                    }
                });
                
                logActivity(`Loaded ${cameras.length} camera(s)`);
            } catch (error) {
                console.error('Error loading cameras:', error);
                showAlert('Failed to load cameras: ' + error.message, 'danger');
                logActivity('Error: Failed to load cameras');
            }
        }

        // Load violation directory information
        async function loadViolationInfo() {
            try {
                const response = await fetch('/get_violation_info');
                if (!response.ok) throw new Error('Failed to fetch violation info');
                
                const info = await response.json();
                
                document.getElementById('saveDirectory').textContent = info.save_directory || 'Not configured';
                document.getElementById('totalFiles').textContent = info.total_files || 0;
                
                // Calculate estimated disk usage (rough estimate)
                const estimatedSize = (info.total_files || 0) * 0.5; // ~0.5MB per image
                document.getElementById('diskUsage').textContent = estimatedSize.toFixed(1);
                
                const lastViolationText = info.last_violation ? 
                    info.last_violation.split('/').pop() : 'None';
                document.getElementById('lastViolation').textContent = lastViolationText;
                
                if (!info.directory_exists) {
                    showAlert('Violation save directory does not exist', 'warning');
                }
            } catch (error) {
                console.error('Error loading violation info:', error);
                logActivity('Error: Failed to load violation info');
            }
        }

        // Start detection system
        async function startDetection() {
            if (isDetectionRunning) return;
            
            const startBtn = document.getElementById('startBtn');
            const startText = document.getElementById('startText');
            
            startBtn.disabled = true;
            startText.innerHTML = '<span class="loading"></span>Starting...';
            
            try {
                const response = await fetch('/start_detection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error('Network response was not ok');
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    isDetectionRunning = true;
                    startText.innerHTML = '<span class="loading"></span>Running';
                    updateCameraStatus(selectedCamera, 'running');
                    updateSystemStatusBadge('running');
                    showAlert('Detection started successfully', 'success');
                    logActivity('Detection system activated');
                } else {
                    throw new Error(result.message || 'Unknown error');
                }
            } catch (error) {
                console.error('Error starting detection:', error);
                startText.textContent = 'Start Detection';
                showAlert('Failed to start detection: ' + error.message, 'danger');
                logActivity('Error: Failed to start detection');
            } finally {
                startBtn.disabled = false;
            }
        }

        // Stop detection system
        async function stopDetection() {
            if (!isDetectionRunning) return;
            
            const stopBtn = document.getElementById('stopBtn');
            const startText = document.getElementById('startText');
            
            stopBtn.disabled = true;
            
            try {
                const response = await fetch('/stop_detection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error('Network response was not ok');
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    isDetectionRunning = false;
                    startText.textContent = 'Start Detection';
                    document.getElementById('violationAlert').style.display = 'none';
                    updateAllCameraStatus('stopped');
                    updateSystemStatusBadge('stopped');
                    showAlert('Detection stopped', 'warning');
                    logActivity('Detection system deactivated');
                } else {
                    throw new Error(result.message || 'Unknown error');
                }
            } catch (error) {
                console.error('Error stopping detection:', error);
                showAlert('Failed to stop detection: ' + error.message, 'danger');
                logActivity('Error: Failed to stop detection');
            } finally {
                stopBtn.disabled = false;
            }
        }

        // Reset violation counters
        async function resetViolations() {
            const resetBtn = document.getElementById('resetBtn');
            resetBtn.disabled = true;
            
            try {
                const response = await fetch('/reset_violations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error('Network response was not ok');
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    document.getElementById('violationAlert').style.display = 'none';
                    lastViolationCount = 0;
                    showAlert('Violation counters reset successfully', 'success');
                    logActivity('Violation counters reset to zero');
                    updateStats(); // Refresh stats immediately
                } else {
                    throw new Error(result.message || 'Unknown error');
                }
            } catch (error) {
                console.error('Error resetting violations:', error);
                showAlert('Failed to reset violations: ' + error.message, 'danger');
                logActivity('Error: Failed to reset violations');
            } finally {
                resetBtn.disabled = false;
            }
        }

        // Switch camera
        async function selectCamera(cameraId) {
            if (cameraId === selectedCamera) return;
            
            try {
                const response = await fetch('/switch_camera', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ camera_id: cameraId })
                });
                
                if (!response.ok) throw new Error('Network response was not ok');
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Update UI
                    document.querySelectorAll('.camera-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    event.target.closest('.camera-item').classList.add('active');
                    
                    selectedCamera = cameraId;
                    
                    showAlert(result.message, 'success');
                    logActivity(`Switched to camera: ${result.camera_name}`);
                    
                    // Refresh violation info for new camera
                    loadViolationInfo();
                } else {
                    throw new Error(result.message || 'Unknown error');
                }
            } catch (error) {
                console.error('Error switching camera:', error);
                showAlert('Failed to switch camera: ' + error.message, 'danger');
                logActivity('Error: Failed to switch camera');
            }
        }

        // Update system statistics
        async function updateStats() {
            try {
                const response = await fetch('/get_stats');
                if (!response.ok) throw new Error('Failed to fetch stats');
                
                const stats = await response.json();
                
                if (stats.status !== 'error') {
                    // Update stat cards
                    document.getElementById('totalViolations').textContent = stats.total_violations || 0;
                    document.getElementById('activeViolations').textContent = stats.active_violations || 0;
                    document.getElementById('currentFPS').textContent = stats.fps || 0;
                    document.getElementById('systemStatus').textContent = 
                        stats.status === 'running' ? 'Active' : 'Stopped';
                    
                    // Update camera info
                    const status = stats.status === 'running' ? 'Active - Detecting' : 'Stopped';
                    document.getElementById('cameraInfo').innerHTML = 
                        `${stats.camera_name || 'No Camera'} | Status: ${status}
                         <span class="system-status ${stats.status === 'running' ? 'status-running' : 'status-stopped'}" 
                               id="systemStatusBadge">${stats.status === 'running' ? 'Running' : 'Stopped'}</span>`;
                    
                    // Show violation alert if active violations > 0
                    if (stats.active_violations > 0 && isDetectionRunning) {
                        document.getElementById('violationAlert').style.display = 'block';
                    } else {
                        document.getElementById('violationAlert').style.display = 'none';
                    }
                    
                    // Check for new violations and log them
                    if (stats.total_violations > lastViolationCount) {
                        const newViolations = stats.total_violations - lastViolationCount;
                        logActivity(`${newViolations} new violation(s) detected`);
                        lastViolationCount = stats.total_violations;
                    }
                    
                    // Update violation info if there's a new violation
                    if (stats.last_violation_path) {
                        loadViolationInfo(); // Refresh violation info
                    }
                    
                    // Update running status
                    isDetectionRunning = (stats.status === 'running');
                }
            } catch (error) {
                console.error('Error updating stats:', error);
                logActivity('Error: Failed to update statistics');
            }
        }

        // Update camera status indicator
        function updateCameraStatus(cameraId, status) {
            const statusElement = document.getElementById(`status-${cameraId}`);
            if (statusElement) {
                const statusClass = status === 'running' ? 'status-running' : 'status-stopped';
                statusElement.className = `status-indicator ${statusClass}`;
            }
        }

        // Update all camera status indicators
        function updateAllCameraStatus(status) {
            cameras.forEach(camera => {
                updateCameraStatus(camera.id, status);
            });
        }

        // Update system status badge
        function updateSystemStatusBadge(status) {
            const badge = document.getElementById('systemStatusBadge');
            if (badge) {
                badge.className = `system-status ${status === 'running' ? 'status-running' : 'status-stopped'}`;
                badge.textContent = status === 'running' ? 'Running' : 'Stopped';
            }
        }

        // Start stats updater interval
        function startStatsUpdater() {
            // Update stats every 2 seconds
            statsInterval = setInterval(() => {
                updateStats();
                // Also refresh violation info every 10 seconds
                if (Date.now() % 10000 < 2000) {
                    loadViolationInfo();
                }
            }, 2000);
        }

        // Show alert messages
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            alertContainer.appendChild(alert);
            
            // Auto-remove alert after 5 seconds
            setTimeout(() => {
                if (alertContainer.contains(alert)) {
                    alertContainer.removeChild(alert);
                }
            }, 5000);
        }

        // Log activity to the panel
        function logActivity(message) {
            const logPanel = document.getElementById('logPanel');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.innerHTML = `<div class="timestamp">${timestamp} - ${message}</div>`;
            
            // Insert at the beginning
            logPanel.insertBefore(logEntry, logPanel.firstChild);
            
            // Limit log entries to 15
            while (logPanel.children.length > 15) {
                logPanel.removeChild(logPanel.lastChild);
            }
        }

        // Handle page visibility changes to optimize performance
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                // Refresh data when page becomes visible
                updateStats();
                loadViolationInfo();
                logActivity('Page became visible - refreshing data');
            } else {
                logActivity('Page hidden - continuing background monitoring');
            }
        });

        // Handle window beforeunload to stop detection gracefully
        window.addEventListener('beforeunload', function(e) {
            if (isDetectionRunning) {
                e.preventDefault();
                e.returnValue = 'Detection is still running. Are you sure you want to leave?';
                return e.returnValue;
            }
        });

        // Handle network connection status
        window.addEventListener('online', function() {
            showAlert('Network connection restored', 'success');
            logActivity('Network connection restored');
            updateStats();
        });

        window.addEventListener('offline', function() {
            showAlert('Network connection lost', 'danger');
            logActivity('Network connection lost');
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Only if not typing in an input field
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                switch(e.key) {
                    case 's':
                    case 'S':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            if (!isDetectionRunning) {
                                startDetection();
                            } else {
                                stopDetection();
                            }
                        }
                        break;
                    case 'r':
                    case 'R':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            resetViolations();
                        }
                        break;
                }
            }
        });

        // Add connection status monitoring
        function checkConnection() {
            fetch('/get_stats', { 
                method: 'GET',
                cache: 'no-cache'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Server connection failed');
                }
                // Connection is good, clear any previous connection errors
                const existingConnectionAlerts = document.querySelectorAll('.alert-danger');
                existingConnectionAlerts.forEach(alert => {
                    if (alert.textContent.includes('connection')) {
                        alert.remove();
                    }
                });
            })
            .catch(error => {
                console.error('Connection check failed:', error);
                showAlert('Server connection lost. Retrying...', 'danger');
                logActivity('Server connection lost - retrying...');
            });
        }

        // Check connection every 10 seconds
        setInterval(checkConnection, 10000);

        // Performance monitoring
        let performanceMetrics = {
            frameUpdates: 0,
            lastFrameTime: Date.now()
        };

        // Monitor video feed performance
        setInterval(() => {
            const videoFeed = document.getElementById('videoFeed');
            if (videoFeed && videoFeed.complete) {
                performanceMetrics.frameUpdates++;
                const now = Date.now();
                const timeDiff = now - performanceMetrics.lastFrameTime;
                
                if (timeDiff > 5000) { // Every 5 seconds
                    const fps = (performanceMetrics.frameUpdates / timeDiff) * 1000;
                    if (fps < 15 && isDetectionRunning) {
                        logActivity(`Video feed performance warning: ${fps.toFixed(1)} FPS`);
                    }
                    performanceMetrics.frameUpdates = 0;
                    performanceMetrics.lastFrameTime = now;
                }
            }
        }, 1000);

        // Initialize tooltips for better UX
        function initializeTooltips() {
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(button => {
                button.addEventListener('mouseenter', function() {
                    // Add subtle hover effects or tooltips here if needed
                });
            });
        }

        // Call initialization functions
        setTimeout(() => {
            initializeTooltips();
            logActivity('Dashboard fully initialized');
        }, 1000);
    </script>
</body>

</html>
